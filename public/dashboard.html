<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>Dashboard - Store Manager</title>
	<link rel="stylesheet" href="style.css" />
	<style>
		.navbar {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 15px 20px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
		}

		.navbar h1 {
			margin: 0;
			font-size: 24px;
		}

		.nav-buttons {
			display: flex;
			gap: 15px;
			align-items: center;
		}

		.nav-buttons button {
			padding: 8px 16px;
			background: white;
			border: none;
			border-radius: 5px;
			cursor: pointer;
			font-weight: 600;
			transition: transform 0.2s;
		}

		.nav-buttons button:hover {
			transform: translateY(-2px);
		}

		.nav-buttons .logout-btn {
			background: #ff6b6b;
			color: white;
		}

		.user-info {
			color: white;
			font-size: 14px;
		}
	</style>
</head>
<body>
	<div class="navbar">
		<h1>üè™ Store Manager Dashboard</h1>
		<div class="nav-buttons">
			<div class="user-info">
				Hello, <span id="userName">User</span>
			</div>
			<button id="manageUsersBtn" onclick="goToUsers()" style="display:none;">üë• Manage Users</button>
			<button id="viewLogsBtn" onclick="goToLogs()" style="display:none;">üìú View Logs</button>
			<button class="logout-btn" onclick="logout()">üö™ Logout</button>
		</div>
	</div>

	<div class="container">
		<!-- Search Section -->
		<div class="search-section">
			<h3>üîç Quick Lookup</h3>
			<div class="search-box">
				<input type="text" id="storeCode" placeholder="Enter Store Code (e.g., 1341413)" />
				<button onclick="findStore()">Search</button>
			</div>
			<div id="result"></div>
		</div>

		<!-- Add/Edit Form -->
		<div class="form-section">
			<h3>‚ûï Add New Store</h3>
			<form id="storeForm" onsubmit="return false;">
				<div class="form-grid">
					<div class="form-group">
						<label>Store Code *</label>
						<input type="text" id="crudCode" placeholder="e.g., 1341413" pattern="[0-9]+" title="Numbers only" />
						<span class="error-msg" id="codeError"></span>
					</div>
					
					<div class="form-group">
						<label>Manager Designation *</label>
						<select id="crudDesignation">
							<option value="">Select...</option>
							<option value="Mr">Mr</option>
							<option value="Mrs">Mrs</option>
							<option value="Miss">Miss</option>
							<option value="Dr">Dr</option>
							<option value="Ms">Ms</option>
						</select>
					</div>
					
					<div class="form-group">
						<label>Manager Name *</label>
						<input type="text" id="crudManager" placeholder="e.g., John Doe" pattern="[A-Za-z\s]+" title="Alphabets only" />
						<span class="error-msg" id="managerError"></span>
					</div>
					
					<div class="form-group">
						<label>Email *</label>
						<input type="email" id="crudEmail" placeholder="manager@example.com" />
						<span class="error-msg" id="emailError"></span>
					</div>
					
					<div class="form-group">
						<label>Mobile Number *</label>
						<input type="tel" id="crudMobile" placeholder="1234567890" pattern="[0-9]{10}" maxlength="10" title="10 digit number" />
						<span class="error-msg" id="mobileError"></span>
					</div>
				</div>
				
				<div class="form-group">
					<label>Store Type *</label>
					<div class="radio-group">
						<label>
							<input type="radio" name="storeType" value="store" checked />
							Store
						</label>
						<label>
							<input type="radio" name="storeType" value="branch" />
							Branch
						</label>
					</div>
				</div>

				<div class="form-actions">
					<button type="button" class="btn btn-primary" onclick="addStore()">Add Store</button>
				</div>
			</form>
		</div>

		<!-- Stores List -->
		<div class="stores-list">
			<h3 style="align-items: center;">üìã All Stores</h3>
			<div style="margin-bottom:16px;">
				<h4>Bulk Import Stores</h4>
				<form id="importForm" enctype="multipart/form-data">
					<input type="file" id="importFile" name="file" accept=".csv" />
					<button type="submit">Import CSV</button>
					<a href="/sample.csv" download style="margin-left:10px;">Download Sample CSV</a>
				</form>
				<div id="importResult" style="margin-top:8px;color:#333;"></div>
			</div>
			<ul id="storeList"></ul>
		</div>
	</div>

	<script>
		// Check if user is logged in
		window.addEventListener('load', () => {
			const token = localStorage.getItem('authToken');
			const user = JSON.parse(localStorage.getItem('user') || '{}');

			if (!token) {
				window.location.href = '/login.html';
				return;
			}

			// Set user name
			document.getElementById('userName').textContent = user.name || 'User';

			// Show "Manage Users" button only for admins
			if (user.is_admin) {
				document.getElementById('manageUsersBtn').style.display = 'block';
			}

			// Show "View Logs" only for main user (user_type === 2)
			if (user.user_type === 2) {
				document.getElementById('viewLogsBtn').style.display = 'block';
			}
		});

		function goToUsers() {
			window.location.href = '/users.html';
		}

		function goToLogs() {
			window.location.href = '/logs.html';
		}

		function logout() {
			localStorage.removeItem('authToken');
			localStorage.removeItem('user');
			window.location.href = '/login.html';
		}

		// Add auth token to all API calls
		async function apiCall(url, options = {}) {
			const token = localStorage.getItem('authToken');
			const headers = {
				'Content-Type': 'application/json',
				...options.headers,
			};

			if (token) {
				headers.Authorization = `Bearer ${token}`;
			}

			return fetch(url, {
				...options,
				headers,
			});
		}
	</script>
	<script src="script.js"></script>
	<script>
	document.getElementById('importForm').addEventListener('submit', async function(e) {
		e.preventDefault();
		const fileInput = document.getElementById('importFile');
		const resultDiv = document.getElementById('importResult');
		resultDiv.textContent = '';
		if (!fileInput.files.length) {
			resultDiv.textContent = 'Please select a CSV file.';
			return;
		}
		const formData = new FormData();
		formData.append('file', fileInput.files[0]);
		const token = localStorage.getItem('authToken');
		try {
			const res = await fetch('/api/stores/import', {
				method: 'POST',
				headers: token ? { Authorization: `Bearer ${token}` } : {},
				body: formData
			});
			const data = await res.json();
			if (data.success) {
				let msg = `Import complete. Updated: ${data.results.filter(r=>r.action==='updated').length}, Created: ${data.results.filter(r=>r.action==='created').length}`;
				if (data.errors.length) msg += `. Errors: ${data.errors.length}`;
				resultDiv.textContent = msg;
				loadStores();
			} else {
				resultDiv.textContent = data.message || 'Import failed.';
			}
		} catch (err) {
			resultDiv.textContent = 'Error importing: ' + err.message;
		}
	});
	</script>
</body>
</html>
